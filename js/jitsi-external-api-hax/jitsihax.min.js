class MockAudioContext{constructor(){this._t=performance.now()/1e3}get currentTime(){return performance.now()/1e3-this._t}get destination(){return null}}function isGoodNumber(t){return null!=t&&("number"==typeof t||t instanceof Number)&&!Number.isNaN(t)}function clamp(t,e,i){return Math.min(i,Math.max(e,t))}function lerp(t,e,i){return(1-i)*t+i*e}function project(t,e,i){return(t-e)/(i-e)}class BasePosition{get x(){throw new Error("Not implemented in base class.")}get y(){throw new Error("Not implemented in base class.")}setTarget(t,e,i){throw new Error("Not implemented in base class.")}update(t){}}class InterpolatedPosition extends BasePosition{constructor(){super(),this._st=this._et=0,this._x=this._tx=this._sx=0,this._y=this._ty=this._sy=0}get x(){return this._x}get y(){return this._y}setTarget(t,e,i){this._st=e,this._et=e+i,this._sx=this._x,this._sy=this._y,this._tx=t.x,this._ty=t.y}update(t){const e=project(t,this._st,this._et);e<=1&&(this._x=lerp(this._sx,this._tx,e),this._y=lerp(this._sy,this._ty,e))}}class WebAudioOldListenerPosition extends InterpolatedPosition{constructor(t){super(),this.listener=t,this.listener.setPosition(0,0,0),this.listener.setOrientation(0,0,-1,0,1,0)}update(t){super.update(t),this.listener.setPosition(this.x,0,this.y)}}class WebAudioNodePosition extends BasePosition{constructor(t,e){super(),this._p=e?new InterpolatedPosition:null,this.node=t,this.node.positionX.setValueAtTime(0,0),this.node.positionY.setValueAtTime(0,0),this.node.positionZ.setValueAtTime(0,0)}get x(){return this.node.positionX.value}get y(){return this.node.positionZ.value}setTarget(t,e,i){if(this._p)this._p.setTarget(t,e,i);else{const s=e+i;this.node.positionX.linearRampToValueAtTime(t.x,s),this.node.positionZ.linearRampToValueAtTime(t.y,s)}}update(t){this._p&&(this._p.update(t),this.node.positionX.linearRampToValueAtTime(this._p.x,0),this.node.positionZ.linearRampToValueAtTime(this._p.y,0))}}class WebAudioNewListenerPosition extends WebAudioNodePosition{constructor(t,e){super(t,e),this.node.forwardX.setValueAtTime(0,0),this.node.forwardY.setValueAtTime(0,0),this.node.forwardZ.setValueAtTime(-1,0),this.node.upX.setValueAtTime(0,0),this.node.upY.setValueAtTime(1,0),this.node.upZ.setValueAtTime(0,0)}}class BaseSpatializer extends EventTarget{constructor(t,e,i,s){super(),this.id=t,this.destination=e,this.audio=i,this.position=s,this.volume=1,this.pan=0,this.wasMuted=!1}dispose(){this.audio.pause(),this.position=null,this.audio=null,this.destination=null,this.id=null}mute(){throw new Error("Not implemented in base class")}unmute(){throw new Error("Not implemented in base class")}update(){this.position.update(this.destination.audioContext.currentTime);const t=this.destination.position.x,e=this.destination.position.y,i=this.position.x-t,s=this.position.y-e,o=Math.sqrt(i*i+s*s),n=project(o,this.destination.minDistance,this.destination.maxDistance);this.volume=1-clamp(n,0,1),this.pan=o>0?i/o:0;const r=this.volume<=0;r!==this.wasMuted&&(this.wasMuted=r,r?this.mute():this.unmute())}setTarget(t){this.position.setTarget(t,this.destination.audioContext.currentTime,this.destination.transitionTime),this.update()}}class VolumeOnlySpatializer extends BaseSpatializer{constructor(t,e,i){super(t,e,i,new InterpolatedPosition),this.audio.play(),Object.seal(this)}update(){super.update(),this.audio.volume=this.volume}mute(){this.audio.muted=!0}unmute(){this.audio.muted=!1}}const audioActivityEvt=Object.assign(new Event("audioActivity",{id:null,isActive:!1})),activityCounterMin=0,activityCounterMax=60,activityCounterThresh=5;function frequencyToIndex(t,e,i){var s=e/2;return clamp(Math.round(t/s*i),0,i)}function analyserFrequencyAverage(t,e,i,s,o){const n=t.context.sampleRate,r=frequencyToIndex(i,n,o),a=frequencyToIndex(s,n,o),u=a-r;let h=0;for(let t=r;t<a;++t)h+=e[t];return 0===u?0:h/u}class BaseWebAudioSpatializer extends BaseSpatializer{constructor(t,e,i,s,o,n,r){super(t,e,i,s),this.audio.volume=0,this.bufferSize=o,this.buffer=new Float32Array(this.bufferSize),this.analyser=this.destination.audioContext.createAnalyser(),this.analyser.fftSize=2*this.bufferSize,this.analyser.smoothingTimeConstant=.2,this.inNode=n,this.outNode=r||n,this.outNode.connect(this.destination.audioContext.destination),this.inNode!==this.outNode&&this.inNode.connect(this.outNode),this.wasActive=!1,this.lastAudible=!0,this.activityCounter=0,this.stream=null,this.source=null}mute(){this.outNode.disconnect(this.destination.audioContext.destination)}unmute(){this.outNode.connect(this.destination.audioContext.destination)}update(){if(super.update(),!this.source)try{this.stream||(this.stream=this.audio.mozCaptureStream?this.audio.mozCaptureStream():this.audio.captureStream()),this.stream.active&&(this.source=this.destination.audioContext.createMediaStreamSource(this.stream),this.source.connect(this.analyser),this.source.connect(this.inNode))}catch(t){console.warn("Source isn't available yet. Will retry in a moment. Reason: ",t)}if(this.source){this.analyser.getFloatFrequencyData(this.buffer);const t=1.1+analyserFrequencyAverage(this.analyser,this.buffer,85,255,this.bufferSize)/100;t>=.5&&this.activityCounter<60?this.activityCounter++:t<.5&&this.activityCounter>0&&this.activityCounter--;const e=this.activityCounter>5;this.wasActive!==e&&(this.wasActive=e,audioActivityEvt.id=this.id,audioActivityEvt.isActive=e,this.dispatchEvent(audioActivityEvt))}}dispose(){this.source&&(this.source.disconnect(this.analyser),this.source.disconnect(this.inNode)),this.outNode.disconnect(this.destination.audioContext.destination),this.inNode!==this.outNode&&this.inNode.disconnect(this.outNode),this.source=null,this.stream=null,this.outNode=null,this.inNode=null,this.analyser=null,this.buffer=null,super.dispose()}}class FullSpatializer extends BaseWebAudioSpatializer{constructor(t,e,i,s,o){const n=e.audioContext.createPanner();super(t,e,i,new WebAudioNodePosition(n,o),s,n),this.forceInterpolatedPosition=o,this.inNode.panningModel="HRTF",this.inNode.distanceModel="inverse",this.inNode.refDistance=e.minDistance,this.inNode.rolloffFactor=e.rolloff,this.inNode.coneInnerAngle=360,this.inNode.coneOuterAngle=0,this.inNode.coneOuterGain=0,Object.seal(this)}update(){super.update(),this.inNode.refDistance!==this.destination.minDistance&&(this.inNode.refDistance=this.destination.minDistance),this.inNode.rolloffFactor!==this.destination.rolloff&&(this.inNode.rolloffFactor=this.destination.rolloff)}}class StereoSpatializer extends BaseWebAudioSpatializer{constructor(t,e,i,s){super(t,e,i,new InterpolatedPosition,s,e.audioContext.createStereoPanner(),e.audioContext.createGain()),Object.seal(this)}update(){super.update(),this.inNode.pan.value=this.pan,this.outNode.gain.value=this.volume}}const forceInterpolatedPosition=!0,contextDestroyingEvt=new Event("contextDestroying"),contextDestroyedEvt=new Event("contextDestroyed");let hasWebAudioAPI=window.hasOwnProperty("AudioListener"),hasFullSpatializer=hasWebAudioAPI&&window.hasOwnProperty("PannerNode"),isLatestWebAudioAPI=hasWebAudioAPI&&AudioListener.prototype.hasOwnProperty("positionX");class Destination extends EventTarget{constructor(){super(),this.minDistance=1,this.maxDistance=10,this.rolloff=1,this.transitionTime=.125,this.audioContext=null,this.position=null,this.createContext()}createContext(){if(!this.audioContext)try{if(hasWebAudioAPI){this.audioContext=new AudioContext;try{isLatestWebAudioAPI&&(this.position=new WebAudioNewListenerPosition(this.audioContext.listener,!0))}catch(t){isLatestWebAudioAPI=!1,console.warn("No AudioListener.positionX property!",t)}finally{isLatestWebAudioAPI||(this.position=new WebAudioOldListenerPosition(this.audioContext.listener))}}}catch(t){hasWebAudioAPI=!1,console.warn("No WebAudio API!",t)}finally{hasWebAudioAPI||(this.audioContext=new MockAudioContext,this.position=new InterpolatedPosition)}}setTarget(t){this.position.setTarget(t,this.audioContext.currentTime,this.transitionTime),this.update()}setAudioProperties(t){this.minDistance=t.minDistance,this.maxDistance=t.maxDistance,this.transitionTime=t.transitionTime,this.rolloff=t.rolloff}update(){this.position.update(this.audioContext.currentTime)}createSpatializer(t,e,i){try{if(hasWebAudioAPI)try{if(hasFullSpatializer)return new FullSpatializer(t,this,e,i,!0)}catch(t){hasFullSpatializer=!1,console.warn("No 360 spatializer support",t)}finally{if(!hasFullSpatializer)return new StereoSpatializer(t,this,e,i)}}catch(t){hasWebAudioAPI=!1,this.audioContext&&(this.dispatchEvent(contextDestroyingEvt),this.audioContext.close(),this.audioContext=null,this.position=null,this.dispatchEvent(contextDestroyedEvt)),console.warn("No WebAudio API!",t)}finally{if(!hasWebAudioAPI)return new VolumeOnlySpatializer(t,this,e)}}}class BaseAudioClient extends EventTarget{constructor(){super()}setLocalPosition(t){throw new Error("Not implemented in base class")}setUserPosition(t){throw new Error("Not implemented in base class")}setAudioProperties(t){throw new Error("Not implemented in base class")}removeUser(t){throw new Error("Not implemented in base class")}}const tickEvt=Object.assign(new Event("tick"),{dt:0});class BaseTimer extends EventTarget{constructor(t){super(),this._lt=0,this._timer=null,this.targetFrameRate=t}_onTick(t){tickEvt.dt=t,this.dispatchEvent(tickEvt)}restart(){this.stop(),this.start()}get isRunning(){return null!==this._timer}start(){throw new Error("Not implemented in base class")}stop(){this._timer=null}get targetFrameRate(){return this._targetFPS}set targetFrameRate(t){this._targetFPS=t,this._frameTime=1e3/t}}Element.prototype.isOpen=function(){return"none"!==this.style.display},Element.prototype.setOpen=function(t,e=""){this.style.display=t?e:"none"},Element.prototype.setOpenWithLabel=function(t,e,i,s,o,n=""){this.setOpen(t,n),e.updateLabel(this.isOpen(),i,s,o)},Element.prototype.updateLabel=function(t,e,i,s){s=s||"",this.accessKey&&(s+=` <kbd>(ALT+${this.accessKey.toUpperCase()})</kbd>`),this.innerHTML=(t?e:i)+s},Element.prototype.toggleOpen=function(t=""){this.setOpen(!this.isOpen(),t)},Element.prototype.toggleOpenWithLabel=function(t,e,i,s,o=""){this.setOpenWithLabel(!this.isOpen(),t,e,i,s,o)},Element.prototype.show=function(t=""){this.setOpen(!0,t)},Element.prototype.hide=function(){this.setOpen(!1)},Element.prototype.setLocked=function(t){t?this.lock():this.unlock()},Element.prototype.lock=function(){this.disabled="disabled"},Element.prototype.unlock=function(){this.disabled=""},Element.prototype.blinkBorder=function(t,e){t=2*(t||3),e=e||"rgb(255, 127, 127)";let i=!1;const s=setInterval(()=>{i=!i,this.style.backgroundColor=i?e:"",0===--t&&clearInterval(s)},125)},HTMLCanvasElement.prototype.resize=function(){this.width=this.clientWidth*devicePixelRatio,this.height=this.clientHeight*devicePixelRatio};const oldAddEventListener=HTMLInputElement.prototype.addEventListener;function add(t,e){return i=>{t(i),e(i)}}function isFunction(t){return"function"==typeof t||t instanceof Function}function createWorker(t,e=!0){if(isFunction(t))t=t.toString(),e=!0;else if("string"!=typeof t&&!(t instanceof String))throw new Error("Script parameter must be either a string or function");if(e){const e=(t=t.trim()).indexOf("{");t=t.substring(e+1,t.length-1)}const i=new Blob([t],{type:"text/javascript"}),s=URL.createObjectURL(i);return new Worker(s)}HTMLInputElement.prototype.addEventListener=function(t,e,i){"enter"===t?oldAddEventListener.call(this,"keypress",(function(t){"Enter"===t.key&&e(t)}),i):oldAddEventListener.call(this,t,e,i)},Response.prototype.xml=async function(){const t=await this.text();return(new DOMParser).parseFromString(t,"text/xml").documentElement},Response.prototype.html=async function(){const t=await this.text();return(new DOMParser).parseFromString(t,"text/html").documentElement},Array.prototype.random=function(t){const e=t?1:0,i=Math.floor(Math.random()*(this.length+e))-e;return i<0?t:this[i]},HTMLSelectElement.prototype.setSelectedValue=function(t){if(this.value="",null!=t){t=t.toString();for(let e of this.options)if(e.value===t)return void(this.value=t)}},Storage.prototype.getInt=function(t,e){const i=parseFloat(this.getItem(t));return Number.isInteger(i)?i:e},Event.clone=function(t,...e){for(let i of e)for(let e in i)"isTrusted"!==e&&(t[e]=i[e]);return t},EventTarget.prototype.once=function(t,e,i){return void 0===i&&isGoodNumber(e)&&(i=e,e=void 0),new Promise((s,o)=>{const n=null!=t,r=null!=e,a=add(()=>{n&&this.removeEventListener(t,s)},()=>{r&&this.removeEventListener(e,o)});if(s=add(a,s),o=add(a,o),null!=i){const t=setTimeout(()=>{o("Timeout")},i),e=()=>clearTimeout(t);s=add(e,s),o=add(e,o)}n&&this.addEventListener(t,s),r&&this.addEventListener(e,()=>{o("Rejection event found")})})},EventTarget.prototype.until=function(t,e,i,s,o){return new Promise((n,r)=>{let a=null,u=null;const h=()=>{null!==a&&clearTimeout(a),null!==u&&clearTimeout(u),this.removeEventListener(t,c)};function c(t){i(t)&&(h(),n(t))}this.addEventListener(t,c),void 0!==o&&(u=setTimeout(()=>{h(),r("timeout")},o)),a=setTimeout((function t(){e(),a=setTimeout(t,s)}),0)})},EventTarget.prototype.addEventListeners=function(t){for(let e in t){let i=t[e],s=void 0;i instanceof Array&&(s=i[1],i=i[0]),this.addEventListener(e,i,s)}},Array.prototype.clear=function(){this.splice(0)},Array.prototype.removeAt=function(t){this.splice(t,1)},String.prototype.firstLetterToUpper=function(){return this[0].toLocaleUpperCase()+this.substring(1)};class WorkerTimer extends BaseTimer{constructor(t){super(t),this._running=!1,this._timer=createWorker((function(){let t=0,e=null,i=!1;onmessage=function(s){if("stop"===s.data)i=!1;else{const o=parseFloat(s.data);o===Math.floor(o)&&(e=1e3/o,i||(i=!0,function(){for(;i;){var s=performance.now();s-t>=e&&(postMessage("ok"),t=s)}}()))}}})),this._timer.onmessage=()=>{const t=performance.now(),e=t-this._lt;this._lt=t,this._onTick(e)}}get targetFrameRate(){return super.targetFrameRate}set targetFrameRate(t){super.targetFrameRate=t,this.isRunning&&this._timer.postMessage(t)}start(){this._timer.postMessage(this.targetFrameRate)}stop(){this.isRunning&&this._timer.postMessage("stop")}get isRunning(){return this._running}}const BUFFER_SIZE=1024,audioActivityEvt$1=Object.assign(new Event("audioActivity",{id:null,isActive:!1}));class AudioManager extends BaseAudioClient{constructor(){super(),this.onAudioActivity=t=>{audioActivityEvt$1.id=t.id,audioActivityEvt$1.isActive=t.isActive,this.dispatchEvent(audioActivityEvt$1)},this.sourceLookup=new Map,this.sourceList=[],this.destination=new Destination;const t=[];this.destination.addEventListener("contextDestroying",()=>{for(let e of this.sourceList)e.removeEventListener("audioActivity",this.onAudioActivity),t.push({id:e.id,x:e.position.x,y:e.position.y,audio:e.audio}),this.sourceLookup.delete(e.id),e.dispose();this.sourceList.clear()}),this.destination.addEventListener("contextDestroyed",()=>{this.timer.stop(),this.destination.createContext();for(let e of t){this.createSource(e.id,e.audio).setTarget(e)}t.clear(),this.timer.start()}),this.timer=new WorkerTimer(250),this.timer.addEventListener("tick",()=>{this.destination.update();for(let t of this.sourceList)t.update()}),this.timer.start(),Object.seal(this)}getSource(t){if(!this.sourceLookup.has(t)){const e=`#participant_${t} audio`,i=document.querySelector(e);i&&this.createSource(t,i)}const e=this.sourceLookup.get(t);return e||console.warn("no audio for user "+t),e}createSource(t,e){const i=this.destination.createSpatializer(t,e,1024);return i.addEventListener("audioActivity",this.onAudioActivity),this.sourceList.push(i),this.sourceLookup.set(t,i),i}setUserPosition(t){const e=this.getSource(t.id);e&&e.setTarget(t)}setLocalPosition(t){this.destination.setTarget(t)}setAudioProperties(t){this.destination.setAudioProperties(t)}removeUser(t){if(this.sourceLookup.has(t.id)){const e=this.sourceLookup.get(t.id),i=this.sourceList.indexOf(e);i>-1&&this.sourceList.removeAt(i),e.dispose(),this.sourceLookup.delete(t.id)}}}const FRONT_END_SERVER="https://www.calla.chat",APP_FINGERPRINT="Calla",manager=new AudioManager;let origin=null;function txJitsiHax(t,e){if(null!==origin){const i={hax:"Calla",command:t,value:e};window.parent.postMessage(JSON.stringify(i),origin)}}manager.addEventListener("audioActivity",t=>{txJitsiHax("audioActivity",{id:t.id,isActive:t.isActive})}),window.addEventListener("message",t=>{const e=t.origin.match(/^https?:\/\/localhost\b/);if(t.origin===FRONT_END_SERVER||e)try{const e=JSON.parse(t.data);"Calla"===e.hax&&manager[e.command]&&(manager[e.command](e.value),"setAudioProperties"===e.command&&(origin=e.value.origin,console.log(origin)))}catch(t){console.error(t)}});
